using {{ EntitiesNamespace }};
using {{ ServiceInterfaceNamespace }};
using {{ RepositoryInterfaceNamespace }};
using System.Collections.Generic;
using System.Threading.Tasks;
using ZiggyCreatures.Caching.Fusion;

namespace {{ Namespace }};

public class {{ TableName }}Service(I{{ TableName }}Repository repository) : I{{ TableName }}Service
{
    private readonly FusionCache _cache = new(new FusionCacheOptions());

    public async Task<IEnumerable<{{ TableName }}>> GetAllAsync()
    {
        var cacheKey = "_all_";

        return await _cache.GetOrSetAsync<IEnumerable<{{ TableName }}>>(cacheKey, 
            async _ => await repository.GetAllAsync().ConfigureAwait(false))
            .ConfigureAwait(false);
    }
    
    public async Task<{{ TableName }}?> GetByIdAsync({{ IdTypeName }} {{ IdParameterName }})
    {
        var cacheKey = "{{ IdParameterName }}:" + {{ IdParameterName }};

        return await _cache.GetOrSetAsync<{{ TableName }}?>(cacheKey, 
            async _ => await repository.GetByIdAsync({{ IdParameterName }}).ConfigureAwait(false))
            .ConfigureAwait(false);
    }

    public async Task<bool> AddAsync({{ TableName }} {{ TableParameterName }})
    {
        var result = await repository.AddAsync({{ TableParameterName }}).ConfigureAwait(false);
        await _cache.ClearAsync().ConfigureAwait(false);
        return result > 0;
    }

    public async Task<bool> UpdateAsync({{ TableName }} {{ TableParameterName }})
    {
        var result = await repository.UpdateAsync({{ TableParameterName }}).ConfigureAwait(false);
        await _cache.ClearAsync().ConfigureAwait(false);
        return result > 0;
    }

    public async Task<bool> DeleteAsync({{ TableName }} {{ TableParameterName }})
    {
        var result = await repository.DeleteAsync({{ TableParameterName }}).ConfigureAwait(false);
        await _cache.ClearAsync().ConfigureAwait(false);
        return result > 0;
    }
}