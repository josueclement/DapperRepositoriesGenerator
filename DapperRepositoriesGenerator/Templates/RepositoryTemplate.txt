using {{ EntitiesNamespace }};
using {{ RepositoryInterfaceNamespace }};
using Dapper;
using System.Collections.Generic;
using System.Data.Common;
using System.Data;
using System.Threading.Tasks;
using System;

namespace {{ Namespace }};

public class {{ TableName }}Repository(Func<DbConnection> connectionFactory) : I{{ TableName }}Repository
{
    private const string GetAllSql = "{{ SelectAllRequest }}";
    private const string GetByIdSql = "{{ SelectByIdRequest }}";
    private const string AddSql = "{{ InsertRequest }}";
    private const string UpdateSql = "{{ UpdateRequest }}";
    private const string DeleteSql = "{{ DeleteRequest }}";
    
    public async Task<IEnumerable<{{ TableName }}>> GetAllAsync()
    {
        using var connection = connectionFactory();
        await connection.OpenAsync().ConfigureAwait(false);
        
        return await connection
            .QueryAsync<{{ TableName }}>(GetAllSql)
            .ConfigureAwait(false);
    }
    
    public async Task<IEnumerable<{{ TableName }}>> GetAllAsync(IDbConnection connection, IDbTransaction transaction)
    {
        return await connection
            .QueryAsync<{{ TableName }}>(GetAllSql, transaction)
            .ConfigureAwait(false);
    }

    public async Task<{{ TableName }}?> GetByIdAsync({{ IdTypeName }} {{ IdParameterName }})
    {
        using var connection = connectionFactory();
        await connection.OpenAsync().ConfigureAwait(false);
        
        return await connection
            .QuerySingleOrDefaultAsync<{{ TableName }}>(GetByIdSql, new { {{ IdColumnName }} = {{ IdParameterName }} })
            .ConfigureAwait(false);
    }

    public async Task<{{ TableName }}?> GetByIdAsync({{ IdTypeName }} {{ IdParameterName }}, IDbConnection connection, IDbTransaction transaction)
    {
        return await connection
            .QuerySingleOrDefaultAsync<{{ TableName }}>(GetByIdSql, new { {{ IdColumnName }} = {{ IdParameterName }} }, transaction)
            .ConfigureAwait(false);
    }

    public async Task<int> AddAsync({{ TableName }} {{ TableParameterName }})
    {
        using var connection = connectionFactory();
        await connection.OpenAsync().ConfigureAwait(false);
        
        return await connection
            .ExecuteAsync(AddSql, {{ TableParameterName }})
            .ConfigureAwait(false);
    }

    public async Task<int> AddAsync({{ TableName }} {{ TableParameterName }}, IDbConnection connection, IDbTransaction transaction)
    {
        return await connection
            .ExecuteAsync(AddSql, {{ TableParameterName }}, transaction)
            .ConfigureAwait(false);
    }

    public async Task<int> UpdateAsync({{ TableName }} {{ TableParameterName }})
    {
        using var connection = connectionFactory();
        await connection.OpenAsync().ConfigureAwait(false);
        
        return await connection
            .ExecuteAsync(UpdateSql, {{ TableParameterName }})
            .ConfigureAwait(false);
    }

    public async Task<int> UpdateAsync({{ TableName }} {{ TableParameterName }}, IDbConnection connection, IDbTransaction transaction)
    {
        return await connection
            .ExecuteAsync(UpdateSql, {{ TableParameterName }}, transaction)
            .ConfigureAwait(false);
    }

    public async Task<int> DeleteAsync({{ TableName }} {{ TableParameterName }})
    {
        using var connection = connectionFactory();
        await connection.OpenAsync().ConfigureAwait(false);
        
        return await connection
            .ExecuteAsync(DeleteSql, {{ TableParameterName }})
            .ConfigureAwait(false);
    }

    public async Task<int> DeleteAsync({{ TableName }} {{ TableParameterName }}, IDbConnection connection, IDbTransaction transaction)
    {
        return await connection
            .ExecuteAsync(DeleteSql, {{ TableParameterName }}, transaction)
            .ConfigureAwait(false);
    }
}